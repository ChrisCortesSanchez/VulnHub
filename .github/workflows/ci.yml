name: CI/CD Pipeline - Regression Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov black flake8 bandit
    
    - name: Run Black (formatting check)
      run: black --check app/ exploits/ scanner/ || true
    
    - name: Run Flake8 (linting)
      run: flake8 app/ exploits/ scanner/ --max-line-length=100 --count || true
    
    - name: Run Bandit (security linting)
      run: bandit -r app/ -ll || true

  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    env:
      PYTHONPATH: ${{ github.workspace }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov requests beautifulsoup4
    
    - name: Initialize databases
      run: |
        cd ${{ github.workspace }}
        python app/data/seed_data.py
        python app/secured/data/seed_data_secure.py
    
    - name: Start vulnerable application
      run: |
        cd ${{ github.workspace }}
        nohup python app/app.py > vulnerable.log 2>&1 &
        echo $! > vulnerable.pid
        sleep 5
    
    - name: Test vulnerable version (should have vulnerabilities)
      run: |
        pytest tests/test_vulnerable_regression.py -v
    
    - name: Stop vulnerable application
      run: |
        kill $(cat vulnerable.pid) || true
        sleep 2
    
    - name: Start secure application
      run: |
        cd ${{ github.workspace }}
        nohup python app/secured/app_secure.py > secure.log 2>&1 &
        echo $! > secure.pid
        sleep 5
    
    - name: Test secure version (should block attacks)
      run: |
        pytest tests/test_secure_regression.py -v
    
    - name: Stop secure application
      run: |
        kill $(cat secure.pid) || true
    
    - name: Test scanner functionality
      run: |
        cd ${{ github.workspace }}
        nohup python app/app.py > vuln_for_scan.log 2>&1 &
        echo $! > scan.pid
        sleep 5
        pytest tests/test_scanner_regression.py -v
        kill $(cat scan.pid) || true
    
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: |
          vulnerable.log
          secure.log
          vuln_for_scan.log
    
    - name: Generate test report
      if: always()
      run: |
        echo "## Regression Test Results" >> $GITHUB_STEP_SUMMARY
        echo "✅ Code quality checks completed" >> $GITHUB_STEP_SUMMARY
        echo "✅ Vulnerable version tested (vulnerabilities present)" >> $GITHUB_STEP_SUMMARY
        echo "✅ Secure version tested (attacks blocked)" >> $GITHUB_STEP_SUMMARY
        echo "✅ Scanner functionality validated" >> $GITHUB_STEP_SUMMARY

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: regression-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build vulnerable version
      run: |
        docker build -t safebyr:vulnerable -f docker/Dockerfile.vulnerable .
    
    - name: Build secure version
      run: |
        docker build -t safebyr:secure -f docker/Dockerfile.secure .
    
    - name: Test vulnerable container
      run: |
        docker run -d -p 5001:5001 --name safebyr-test safebyr:vulnerable
        sleep 10
        curl -f http://localhost:5001 || exit 1
        docker stop safebyr-test
        docker rm safebyr-test
    
    - name: Test secure container
      run: |
        docker run -d -p 5002:5002 --name safebyr-secure-test safebyr:secure
        sleep 10
        curl -f http://localhost:5002 || exit 1
        docker stop safebyr-secure-test
        docker rm safebyr-secure-test

  scanner-validation:
    name: Scanner Validation
    runs-on: ubuntu-latest
    needs: regression-tests
    
    env:
      PYTHONPATH: ${{ github.workspace }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Initialize database
      run: |
        cd ${{ github.workspace }}
        python app/data/seed_data.py
    
    - name: Start vulnerable app
      run: |
        cd ${{ github.workspace }}
        nohup python app/app.py > scanner_test.log 2>&1 &
        echo $! > scanner.pid
        sleep 5
    
    - name: Run scanner
      run: |
        cd ${{ github.workspace }}
        python scanner/vulnerability_scanner.py http://localhost:5001 || true
    
    - name: Verify scanner found vulnerabilities
      run: |
        # Check that scanner report was generated
        ls -la docs/
        test -f docs/security_report_*.html || exit 1
        echo "Scanner report generated successfully"
    
    - name: Stop application
      run: kill $(cat scanner.pid) || true
    
    - name: Upload scanner reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scanner-reports
        path: docs/*.html