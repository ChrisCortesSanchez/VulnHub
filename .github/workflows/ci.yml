name: CI/CD Pipeline - Regression Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov black flake8 bandit
    
    - name: Run Black (formatting check)
      run: black --check app/ exploits/ scanner/ || true
    
    - name: Run Flake8 (linting)
      run: flake8 app/ exploits/ scanner/ --max-line-length=100 --count || true
    
    - name: Run Bandit (security linting)
      run: bandit -r app/ -ll || true

  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov requests beautifulsoup4
    
    - name: Initialize databases
      run: |
        python -m app.data.seed_data
        python -m app.secured.data.seed_data_secure
    
    - name: Start vulnerable application
      run: |
        nohup python -m app.app > vulnerable.log 2>&1 &
        echo $! > vulnerable.pid
        sleep 5
    
    - name: Verify vulnerable app is running
      run: |
        if ! kill -0 $(cat vulnerable.pid) 2>/dev/null; then
          echo "ERROR: Vulnerable app process died!"
          cat vulnerable.log
          exit 1
        fi
        
        for i in {1..30}; do
          if curl -s http://localhost:5001/ > /dev/null 2>&1; then
            echo "✓ Vulnerable app is ready on port 5001"
            exit 0
          fi
          echo "Waiting for vulnerable app... ($i/30)"
          sleep 1
        done
        
        echo "ERROR: Vulnerable app failed to respond"
        cat vulnerable.log
        exit 1
    
    - name: Test vulnerable version (should have vulnerabilities)
      run: |
        pytest tests/test_vulnerable_regress.py -v
    
    - name: Stop vulnerable application
      run: |
        kill $(cat vulnerable.pid) || true
        sleep 2
    
    - name: Start secure application
      run: |
        nohup python -m app.secured.app > secure.log 2>&1 &
        echo $! > secure.pid
        sleep 5
    
    - name: Verify secure app is running
      run: |
        # Check if process is still running
        if ! kill -0 $(cat secure.pid) 2>/dev/null; then
          echo "ERROR: Secure app process died immediately!"
          echo "=== Secure App Logs ==="
          cat secure.log
          exit 1
        fi
        
        # Wait for app to be ready (max 30 seconds)
        for i in {1..30}; do
          if curl -s http://localhost:5002/ > /dev/null 2>&1; then
            echo "✓ Secure app is ready on port 5002"
            exit 0
          fi
          echo "Waiting for secure app... ($i/30)"
          sleep 1
        done
        
        echo "ERROR: Secure app failed to respond after 30 seconds"
        echo "=== Secure App Logs ==="
        cat secure.log
        echo "=== Process Status ==="
        ps aux | grep python || true
        echo "=== Port Status ==="
        netstat -tuln | grep 5002 || echo "Port 5002 not listening"
        exit 1
    
    - name: Test secure version (should block attacks)
      run: |
        pytest tests/test_secure_regress.py -v
    
    - name: Show secure app logs on failure
      if: failure()
      run: |
        echo "=== Secure Application Logs ==="
        cat secure.log || echo "No log file found"
    
    - name: Stop secure application
      run: |
        kill $(cat secure.pid) || true
    
    - name: Test scanner functionality
      run: |
        nohup python -m app.app > vuln_for_scan.log 2>&1 &
        echo $! > scan.pid
        sleep 5
    
    - name: Verify scanner app is running
      run: |
        if ! kill -0 $(cat scan.pid) 2>/dev/null; then
          echo "ERROR: App for scanner died!"
          cat vuln_for_scan.log
          exit 1
        fi
        
        for i in {1..30}; do
          if curl -s http://localhost:5001/ > /dev/null 2>&1; then
            echo "✓ App ready for scanner testing"
            exit 0
          fi
          echo "Waiting for app... ($i/30)"
          sleep 1
        done
        
        echo "ERROR: App failed to respond"
        cat vuln_for_scan.log
        exit 1
    
    - name: Run scanner tests
      run: |
        pytest tests/test_scanner_regress.py -v
    
    - name: Stop scanner test app
      run: |
        kill $(cat scan.pid) || true
    
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: |
          vulnerable.log
          secure.log
          vuln_for_scan.log
    
    - name: Generate test report
      if: always()
      run: |
        echo "## Regression Test Results" >> $GITHUB_STEP_SUMMARY
        echo "✅ Code quality checks completed" >> $GITHUB_STEP_SUMMARY
        echo "✅ Vulnerable version tested (vulnerabilities present)" >> $GITHUB_STEP_SUMMARY
        echo "✅ Secure version tested (attacks blocked)" >> $GITHUB_STEP_SUMMARY
        echo "✅ Scanner functionality validated" >> $GITHUB_STEP_SUMMARY

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: regression-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build vulnerable version
      run: |
        docker build -t safebyr:vulnerable -f docker/Dockerfile.vulnerable .
    
    - name: Build secure version
      run: |
        docker build -t safebyr:secure -f docker/Dockerfile.secure .
    
    - name: Test vulnerable container
      run: |
        docker run -d -p 5001:5001 --name safebyr-test safebyr:vulnerable
        sleep 10
        curl -f http://localhost:5001 || exit 1
        docker stop safebyr-test
        docker rm safebyr-test
    
    - name: Test secure container
      run: |
        docker run -d -p 5002:5002 --name safebyr-secure-test safebyr:secure
        sleep 10
        curl -f http://localhost:5002 || exit 1
        docker stop safebyr-secure-test
        docker rm safebyr-secure-test

  scanner-validation:
    name: Scanner Validation
    runs-on: ubuntu-latest
    needs: regression-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Initialize database
      run: |
        python -m app.data.seed_data
    
    - name: Start vulnerable app
      run: |
        nohup python -m app.app > scanner_test.log 2>&1 &
        echo $! > scanner.pid
        sleep 5
    
    - name: Verify app is running for scanner
      run: |
        if ! kill -0 $(cat scanner.pid) 2>/dev/null; then
          echo "ERROR: App died!"
          cat scanner_test.log
          exit 1
        fi
        
        for i in {1..30}; do
          if curl -s http://localhost:5001/ > /dev/null 2>&1; then
            echo "✓ App is ready for scanning"
            exit 0
          fi
          echo "Waiting for app... ($i/30)"
          sleep 1
        done
        
        echo "ERROR: App failed to respond"
        cat scanner_test.log
        exit 1
    
    - name: Run scanner
      run: |
        python scanner/vulnerability_scanner.py http://localhost:5001 || true
    
    - name: Verify scanner found vulnerabilities
      run: |
        ls -la docs/ || true
        test -f docs/security_report_*.html || exit 1
        echo "Scanner report generated successfully"
    
    - name: Stop application
      run: kill $(cat scanner.pid) || true
    
    - name: Upload scanner reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scanner-reports
        path: docs/*.html